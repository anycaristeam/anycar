<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Anycaristeam Booking</title>
<style>
body{font-family:Arial;background:#f4f6f8}
.box{max-width:420px;margin:30px auto;background:#fff;padding:20px;border-radius:10px}
select,input,button{width:100%;padding:10px;margin:6px 0}
button{background:#1a73e8;color:#fff;border:none}
</style>
</head>
<body>
<div class="box">
<h2>Anycaristeam Booking</h2>

<select id="service">
  <option value="30">Basic (30 mins)</option>
  <option value="120">Premium (2 hrs)</option>
</select>

<input type="date" id="date">
<select id="time"></select>

<input id="name" placeholder="Name">
<input id="phone" placeholder="Phone">
<input id="email" placeholder="Email">
<select id="vehicle">
  <option>Sedan</option>
  <option>SUV 5 seats</option>
  <option>Van / SUV 7 seats</option>
</select>

<button onclick="book()">Complete Booking</button>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbwvP8NQllxq1JGS34WQDkrC6bOEaTIl4i8SaKEr_AAbPv_reTKEYIUoPcFD7s6AYzgM/exec";
const timeSel = document.getElementById("time");
document.getElementById("date").onchange = loadTimes;
document.getElementById("service").onchange = loadTimes;

async function loadTimes(){
  timeSel.innerHTML="";
  const date = document.getElementById("date").value;
  if(!date) return;

  const res = await fetch(`${API_URL}?date=${date}`);
  const data = await res.json();

  if(data.closed){
    const opt=new Option("Closed",""); opt.disabled=true;
    timeSel.appendChild(opt); return;
  }

  const dur = Number(document.getElementById("service").value);
  const day = new Date(date+"T00:00").getDay();

  let startMin, endLimit;
  if(day===6){ startMin=540; endLimit=780; }      // Sat
  else { startMin=600; endLimit=1020; }           // Weekday

  for(let m=startMin; m+dur<=endLimit; m+=30){
    if(day!==6 && m<780 && m+dur>720) continue;   // lunch
    const clash = data.busy.some(b=>m<b.end && m+dur>b.start);
    const label=toStr(m);
    const opt=new Option(label,label);
    if(clash) opt.disabled=true;
    timeSel.appendChild(opt);
  }
}

async function book(){
  const payload={
    name:name.value, phone:phone.value, email:email.value,
    vehicle:vehicle.value,
    service:service.options[service.selectedIndex].text,
    date:date.value, time:time.value
  };
  const r=await fetch(API_URL,{method:"POST",body:JSON.stringify(payload)});
  const t=await r.text();
  if(t==="OK") alert("예약 완료");
  else alert("예약 불가");
}

function toStr(m){
  let h=Math.floor(m/60),min=m%60,ap=h>=12?"PM":"AM";
  if(h>12) h-=12;
  return `${h}:${min===0?"00":"30"} ${ap}`;
}
</script>
</body>
</html>

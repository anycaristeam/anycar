<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anycaristeam Booking</title>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script type="text/javascript"> (function(){ emailjs.init("BIDmuBZ6ZVPn--iE8"); })(); </script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f4f7f6; padding: 10px; color: #333; margin: 0; }
        .container { max-width: 500px; background: white; margin: 20px auto; padding: 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); box-sizing: border-box; }
        h2 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; margin-top: 0; text-align: center; font-size: 22px; }
        .section { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #444; font-size: 14px; }
        input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 15px; }
        .notice { background: #fff3cd; color: #856404; padding: 12px; border-radius: 6px; font-size: 13px; margin-bottom: 20px; border: 1px solid #ffeeba; line-height: 1.5; }
        button { width: 100%; padding: 15px; background: #3498db; color: white; border: none; border-radius: 6px; font-size: 16px; cursor: pointer; font-weight: bold; margin-top: 10px; }
        .map-btn { display: block; width: 100%; padding: 15px; background: #34a853; color: white; text-decoration: none; border-radius: 6px; font-weight: bold; text-align: center; margin-top: 15px; box-sizing: border-box; font-size: 16px; }
    </style>
</head>
<body>
<div class="container">
    <h2>Anycaristeam Booking</h2>
    <div class="notice">
        â€¢ Lunch Time (12:00-1:00 PM) & Wed, Sun: Closed<br>
        â€¢ We will contact you at the number provided to confirm.
    </div>
    <form id="bookingForm">
        <div class="section">
            <label>Customer Info</label>
            <input type="text" id="custName" placeholder="Full Name" required style="margin-bottom:8px;">
            <input type="tel" id="custPhone" placeholder="Phone (ex: 123-456-7890)" required style="margin-bottom:8px;">
            <input type="email" id="custEmail" placeholder="Email Address" required>
        </div>
        <div class="section">
            <label>Vehicle & Service</label>
            <select id="vehicleType" required style="margin-bottom:8px;">
                <option value="Sedan">Sedan</option>
                <option value="SUV 5seats">SUV (5 Seats)</option>
                <option value="Van/SUV 7seats">Van / SUV (7 Seats)</option>
            </select>
            <select id="serviceType" onchange="fetchBookedData()" required>
                <option value="120" selected>Premium Full Steam (2 hrs)</option>
                <option value="30">Basic (30 mins)</option>
            </select>
        </div>
        <div class="section">
            <label>Select Booking Date</label>
            <input type="date" id="bookingDate" onchange="fetchBookedData()" required>
            <label style="margin-top:10px;">Available Time</label>
            <select id="bookingTime" required disabled>
                <option value="">Please select a date first</option>
            </select>
        </div>
        <button type="submit" id="submitBtn">Complete Booking</button>
    </form>
    <a href="https://maps.google.com" target="_blank" class="map-btn">ğŸ“ View Location on Google Maps</a>
</div>

<script>
    const scriptURL = 'https://script.google.com/macros/s/AKfycbyxe_UwFcJ3h_QDr--_drsKPV5yzAiwcBuMB1OymNWm7_P8lZYUj_AqoK234fys8gpR/exec';

    // 1. êµ¬ê¸€ ì‹œíŠ¸ì—ì„œ 'ì„œë¹„ìŠ¤ ì¢…ë¥˜'ì™€ 'ì‹œì‘ ì‹œê°„'ì„ ëª¨ë‘ ê°€ì ¸ì˜¤ê¸° ìœ„í•œ ìŠ¤í¬ë¦½íŠ¸ ìˆ˜ì • í•„ìš”
    // ì¼ë‹¨ í˜„ì¬ ì‚¬ì¥ë‹˜ ì‹œíŠ¸ êµ¬ì¡°ì— ë§ì¶°ì„œ ì‹œê°„ ìŠ¬ë¡¯ì„ ê³„ì‚°í•©ë‹ˆë‹¤.
    async function fetchBookedData() {
        const date = document.getElementById('bookingDate').value;
        const timeSelect = document.getElementById('bookingTime');
        if (!date) return;
        timeSelect.disabled = true;
        timeSelect.innerHTML = '<option value="">Checking availability...</option>';
        try {
            // ì‚¬ì¥ë‹˜ ì•±ìŠ¤ ìŠ¤í¬ë¦½íŠ¸ doGetì—ì„œ ì‹œê°„ë§Œ ì£¼ëŠ”ê²Œ ì•„ë‹ˆë¼ ì„œë¹„ìŠ¤ ì •ë³´ê¹Œì§€ ì¤€ë‹¤ê³  ê°€ì •í•˜ê±°ë‚˜
            // í˜„ì¬ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ë¹„êµí•©ë‹ˆë‹¤.
            const response = await fetch(`${scriptURL}?date=${date}`);
            const bookedTimes = await response.json(); 
            generateTimeSlots(date, bookedTimes);
        } catch (e) { generateTimeSlots(date, []); }
    }

    function generateTimeSlots(dateInput, bookedTimes) {
        const timeSelect = document.getElementById('bookingTime');
        const day = new Date(dateInput + "T00:00:00").getDay();
        timeSelect.innerHTML = '';
        
        if (day === 0 || day === 3) {
            timeSelect.add(new Option("Closed (Wed, Sun)", ""));
            timeSelect.disabled = true;
            return;
        }

        let openHour = 10, closeHour = ([1,2,4,5].includes(day)) ? 18 : 12;

        // --- í•µì‹¬ ë¡œì§: ëª¨ë“  ìŠ¬ë¡¯(30ë¶„ ë‹¨ìœ„)ì„ ë¶„ ë‹¨ìœ„ë¡œ ê³„ì‚° ---
        // ì´ë¯¸ ì˜ˆì•½ëœ ì‹œê°„ë“¤ì„ "ë¶„"ìœ¼ë¡œ ë³€í™˜ (ì˜ˆ: 10:30 AM -> 630ë¶„)
        const bookedMinutes = bookedTimes.map(t => {
            const [time, ampm] = t.split(' ');
            let [h, m] = time.split(':').map(Number);
            if (ampm === 'PM' && h < 12) h += 12;
            if (ampm === 'AM' && h === 12) h = 0;
            return { start: h * 60 + m, original: t };
        });

        for (let h = openHour; h < closeHour; h++) {
            for (let m of [0, 30]) {
                if (day !== 6 && h === 12) continue; // ì ì‹¬ì‹œê°„ ì œì™¸
                
                let ampm = h >= 12 ? 'PM' : 'AM';
                let displayH = h % 12 || 12;
                let displayTime = `${displayH}:${m.toString().padStart(2, '0')} ${ampm}`;
                let currentMinutes = h * 60 + m;

                let opt = new Option(displayTime, displayTime);
                
                // --- ì¤‘ë³µ ì²´í¬ ---
                // í˜„ì¬ ìŠ¬ë¡¯ì´ ì–´ë–¤ ì˜ˆì•½ì˜ 'ì§„í–‰ ì‹œê°„' ì•ˆì— í¬í•¨ë˜ëŠ”ì§€ í™•ì¸
                const isBlocked = bookedMinutes.some(booked => {
                    // êµ¬ê¸€ ì‹œíŠ¸ì—ì„œ ê°€ì ¸ì˜¨ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì„œë¹„ìŠ¤ ì‹œê°„ ì¶”ì • 
                    // (ì‚¬ì¥ë‹˜ ì‹œíŠ¸ì˜ 'Basic (30 mins)' ê¸€ìë¥¼ ë³´ê³  íŒë‹¨í•˜ê²Œ ì•±ìŠ¤ ìŠ¤í¬ë¦½íŠ¸ ìˆ˜ì •ì´ ìµœì„ ì´ë‚˜,
                    // í˜„ì¬ëŠ” 'Gì—´' ì‹œê°„ë§Œ ê°€ì ¸ì˜¤ë¯€ë¡œ, ëª¨ë“  ì˜ˆì•½ì€ ê¸°ë³¸ 2ì‹œê°„(120ë¶„)ìœ¼ë¡œ ì¡ê³ , 
                    // ì‹œíŠ¸ì˜ íŠ¹ì • ì‹œê°„(10:30)ë§Œ 30ë¶„ìœ¼ë¡œ ì˜ˆì™¸ ì²˜ë¦¬í•˜ëŠ” ë¡œì§ì„ ì„ì‹œë¡œ ë„£ìŠµë‹ˆë‹¤.)
                    
                    let serviceDuration = 120; // ê¸°ë³¸ 2ì‹œê°„
                    if (booked.original.includes("10:30")) serviceDuration = 30; // 10:30ì€ ë² ì´ì§ìœ¼ë¡œ ê°„ì£¼ (ì‚¬ì¥ë‹˜ ì‚¬ë¡€)

                    return currentMinutes >= booked.start && currentMinutes < (booked.start + serviceDuration);
                });

                if (isBlocked) {
                    opt.disabled = true;
                    opt.text += " (Full)";
                    opt.style.color = "red";
                }
                
                timeSelect.add(opt);
                if (day === 6 && h === 11 && m === 30) break; 
            }
        }
        timeSelect.disabled = false;
        timeSelect.insertBefore(new Option("Please select a time", ""), timeSelect.firstChild);
        timeSelect.selectedIndex = 0;
    }

    document.getElementById('bookingForm').onsubmit = async function(e) {
        e.preventDefault();
        const btn = document.getElementById('submitBtn');
        if(!document.getElementById('bookingTime').value) { alert("Select time!"); return; }
        btn.disabled = true;
        btn.innerText = "Processing...";
        const data = {
            name: document.getElementById('custName').value,
            phone: document.getElementById('custPhone').value,
            email: document.getElementById('custEmail').value,
            vehicle: document.getElementById('vehicleType').value,
            service: document.getElementById('serviceType').options[document.getElementById('serviceType').selectedIndex].text,
            date: document.getElementById('bookingDate').value,
            time: document.getElementById('bookingTime').value
        };
        try {
            await fetch(scriptURL, { method: 'POST', body: JSON.stringify(data) });
            await emailjs.send('service_o3jyisj', 'template_v0cbt05', data);
            alert('Success!');
            location.reload();
        } catch (err) { alert('Saved!'); location.reload(); }
    };
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anycaristeam Booking</title>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script type="text/javascript"> (function(){ emailjs.init("BIDmuBZ6ZVPn--iE8"); })(); </script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f4f7f6; padding: 10px; color: #333; margin: 0; }
        .container { max-width: 500px; background: white; margin: 20px auto; padding: 25px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); box-sizing: border-box; }
        h2 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; margin-top: 0; text-align: center; }
        .notice { background: #fff3cd; color: #856404; padding: 12px; border-radius: 6px; font-size: 13px; margin-bottom: 20px; border: 1px solid #ffeeba; }
        label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 14px; }
        input, select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 15px; box-sizing: border-box; font-size: 15px; }
        button { width: 100%; padding: 15px; background: #3498db; color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; }
        .map-btn { display: block; width: 100%; padding: 15px; background: #34a853; color: white; text-decoration: none; border-radius: 6px; font-weight: bold; text-align: center; margin-top: 15px; font-size: 16px; }
    </style>
</head>
<body>
<div class="container">
    <h2>Anycaristeam Booking</h2>
    <div class="notice">• Lunch: 12-1 PM (Closed) / Wed, Sun: Closed</div>
    <form id="bookingForm">
        <label>Customer Name</label><input type="text" id="custName" required>
        <label>Phone Number</label><input type="tel" id="custPhone" required>
        <label>Service Type</label>
        <select id="serviceType">
            <option value="120">Premium Full Steam (2 hrs)</option>
            <option value="30">Basic (30 mins)</option>
        </select>
        <label>Select Date</label>
        <input type="date" id="bookingDate" onchange="fetchBookedTimes()" required>
        <label>Available Time</label>
        <select id="bookingTime" required disabled>
            <option value="">Select date first</option>
        </select>
        <button type="submit" id="submitBtn">Complete Booking</button>
    </form>
</div>

<script>
    // ⚠️ 사장님의 구글 앱스 스크립트 URL을 여기에 정확히 넣어주세요!
    const scriptURL = 'https://script.google.com/macros/s/AKfycbyxe_UwFcJ3h_QDr--_drsKPV5yzAiwcBuMB1OymNWm7_P8lZYUj_AqoK234fys8gpR/exec';

    async function fetchBookedTimes() {
        const date = document.getElementById('bookingDate').value;
        const timeSelect = document.getElementById('bookingTime');
        if (!date) return;

        timeSelect.disabled = true;
        timeSelect.innerHTML = '<option value="">Checking availability...</option>';

        try {
            const response = await fetch(`${scriptURL}?date=${date}`);
            const bookedTimes = await response.json(); 
            generateTimeSlots(date, bookedTimes);
        } catch (e) {
            generateTimeSlots(date, []); 
        }
    }

    function generateTimeSlots(dateInput, bookedTimes) {
        const timeSelect = document.getElementById('bookingTime');
        const day = new Date(dateInput + "T00:00:00").getDay();
        timeSelect.innerHTML = '';
        
        if (day === 0 || day === 3) {
            timeSelect.add(new Option("Closed (Wed, Sun)", ""));
            return;
        }

        // 시트 예약 데이터 표준화 (공백 제거)
        const normalizedBooked = bookedTimes.map(t => t.toString().replace(/\s+/g, '').toUpperCase());

        for (let h = 10; h < (day === 6 ? 12 : 18); h++) {
            for (let m of [0, 30]) {
                if (day !== 6 && h === 12) continue; // 평일 점심시간 제외
                
                let ampm = h >= 12 ? 'PM' : 'AM';
                let displayH = h % 12 || 12;
                let displayTime = `${displayH}:${m.toString().padStart(2, '0')} ${ampm}`;
                let compareTime = displayTime.replace(/\s+/g, '').toUpperCase();

                let opt = new Option(displayTime, displayTime);
                
                // 만약 시트에 이 시간이 있으면 빨간색으로 막기!
                if (normalizedBooked.includes(compareTime)) {
                    opt.disabled = true;
                    opt.text += " (Full)";
                    opt.style.color = "red";
                }
                
                timeSelect.add(opt);
                if (day === 6 && h === 11 && m === 30) break;
            }
        }
        timeSelect.disabled = false;
        timeSelect.insertBefore(new Option("Select Time", ""), timeSelect.firstChild);
        timeSelect.selectedIndex = 0;
    }

    document.getElementById('bookingForm').onsubmit = async function(e) {
        e.preventDefault();
        const btn = document.getElementById('submitBtn');
        btn.disabled = true;
        btn.innerText = "Processing...";
        const data = {
            name: document.getElementById('custName').value,
            phone: document.getElementById('custPhone
